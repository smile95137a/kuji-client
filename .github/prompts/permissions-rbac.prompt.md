# 權限管理與商品管理功能需求

## 文件用途
本文件描述 RBAC 權限系統與商品管理的業務需求與規則，供 AI 編碼代理理解並實作相關功能。

## ⚠️ 開發前必讀
- **專案架構**: 請先閱讀 `architecture-guide.prompt.md` 了解 MyBatis Generator (MBG) 使用規範
- **開發流程**: DDL 優先 → 執行 MBG → 使用 Example 查詢 → 必要時才手寫 SQL
- **資料表設計**: 本文件提供欄位需求，需轉換為 DDL 後執行 MBG 生成程式碼

---

## 一、權限系統 (RBAC) 需求

### 1.1 角色權限摘要

| 角色         | 可操作範圍                                      | 查看報表       | 修改帳號權限         | 啟用/停用帳號       |
|--------------|-------------------------------------------------|----------------|----------------------|--------------------|
| **Admin**    | 所有店鋪、店鋪編輯者、店鋪數據、權限、報表       | ✔ 全部         | ✔ 全部               | ✔ 全部             |
| **StoreOwner** | 自己店鋪的數據、商品、訂單                     | ✔ 自己店鋪     | ✖                   | ✖                  |
| **StoreEditor** | 商品、獎品、部分訂單                          | ✖              | ✖                   | ✖                  |

### 1.2 核心概念

#### 角色 (Role)
- 系統預設三種角色：Admin、StoreOwner、StoreEditor
- 每個管理者帳號可綁定多個角色（透過 `admin_user_role` 關聯）
- 角色定義包含：角色名稱、角色代碼、描述

#### 選單 (Menu)
- 代表後台的功能頁面或操作權限
- 支援階層式結構（透過 `parent_id` 實現父子選單）
- 每個選單包含：選單名稱、路徑、排序順序、圖示
- 選單可啟用/停用

#### 角色選單權限 (RoleMenu)
- 定義特定角色對特定選單的操作權限
- 權限類型包括：
  - **可查看** (can_view)
  - **可編輯** (can_edit)
  - **可刪除** (can_delete)
- StoreEditor 的權限必須是 StoreOwner 權限的子集

### 1.3 權限檢查機制

#### 檢查流程
1. 查詢當前用戶的所有角色
2. 根據請求路徑查詢對應的選單
3. 檢查用戶的角色是否有該選單的對應權限（查看/編輯/刪除）
4. 若任一角色有權限則允許，否則拒絕

#### 資料隔離原則
- **Admin**: 可查看所有店鋪的資料
- **StoreOwner**: 僅可查看自己店鋪的資料
- **StoreEditor**: 僅可查看所屬店鋪的資料，且權限受限

#### 店鋪過濾邏輯
- 所有涉及店鋪資料的查詢都需加上店鋪過濾條件
- StoreOwner 查詢商品時，自動過濾出所屬店鋪的商品
- Admin 查詢時可跨店鋪查詢

### 1.4 資料表結構需求

#### admin_user (管理者帳號)
- 用戶 ID
- Email（唯一）
- 密碼（加密存儲）
- 暱稱
- 狀態（ACTIVE/INACTIVE）
- 建立時間、更新時間、最後登入時間

#### role (角色表)
- 角色 ID
- 角色名稱
- 角色代碼（如 ROLE_ADMIN）
- 描述
- 建立時間

#### admin_user_role (用戶角色關聯)
- 關聯 ID
- 管理者用戶 ID
- 角色 ID
- 建立時間

#### menu (選單/功能)
- 選單 ID
- 選單名稱
- 選單路徑
- 父選單 ID（支援階層）
- 排序順序
- 圖示
- 是否啟用
- 建立時間

#### role_menu (角色選單權限)
- 關聯 ID
- 角色 ID
- 選單 ID
- 可查看（布林值）
- 可編輯（布林值）
- 可刪除（布林值）
- 建立時間

---

## 二、商品管理需求

### 2.1 商品分類設計

#### 固定分類
系統預設以下商品分類（使用列舉實作）：
- **官方一番賞**: 官方授權的一番賞商品
- **扭蛋**: 傳統扭蛋機商品
- **收藏卡**: 卡牌類收藏品
- **自定義扭蛋**: 店家自行設計的抽獎商品

#### 自定義扭蛋子分類
自定義扭蛋可進一步細分為：
- **抽獎模式**: 一番賞類型，系統隨機分配
- **刮刮卡模式**: 允許玩家指定號碼

#### 分類管理規則
- 後端不支援動態新增分類
- 使用列舉類型定義固定分類
- 若需新增分類，需修改程式碼並重新部署

### 2.2 商品基本資訊

#### 商品欄位需求
- **商品名稱**: 抽獎活動的名稱
- **商品圖片**: 主要展示圖片 URL
- **詳細描述**: 商品介紹文字
- **上架/下架狀態**: 
  - 上架 (ON_SHELF): 玩家可見並可抽
  - 下架 (OFF_SHELF): 玩家不可見
- **定時上架時間**: 可設定未來時間自動上架
- **單次抽獎點數**: 每抽一次所需的點數
- **多次抽獎設定**:
  - 是否允許多次抽獎
  - 多抽選項（如 10 抽、50 抽）
- **所屬店鋪**: 每個商品僅屬於一個店鋪（不可共享）
- **商品分類**: 從固定分類中選擇
- **自定義扭蛋類型**: 若分類為自定義扭蛋，需指定子類型
- **排序**: 用於前端展示順序
- **權重**: 用於推薦演算法（可選）
- **備註**: 內部記錄用

### 2.3 商品與店鋪關聯

#### 綁定原則
- **每個商品必須綁定唯一的店鋪 ID**
- 不同店鋪即使商品名稱相同，也需建立獨立的商品記錄
- 商品不可在店鋪間共享或轉移

#### 資料隔離
- 交易記錄需準確對應到店鋪
- 報表統計需按店鋪分組
- 商品查詢需依用戶權限過濾店鋪

### 2.4 前端查詢需求

#### 需求 1: 依店鋪查詢商品
- 用戶選擇店鋪後，列出該店鋪的所有商品
- 商品列表包含商品名稱、圖片、狀態、剩餘獎項等資訊

#### 需求 2: 依分類查詢店鋪
- 用戶選擇商品分類（如「官方一番賞」）後
- 列出所有提供該分類商品的店鋪
- 回傳店鋪基本資訊與該分類下的商品數量

### 2.5 定時上架功能

#### 業務需求
- 店家可設定商品的「定時上架時間」
- 到達指定時間後，系統自動將商品狀態改為「上架」
- 支援延後上架，適用於預告或限時活動

#### 執行機制
- 系統需定期（建議每分鐘）檢查是否有待上架商品
- 查詢條件: 
  - 狀態為下架
  - 定時上架時間已到
- 符合條件的商品自動變更為上架狀態
- 記錄自動上架事件

---

## 三、API 功能需求

### 3.1 商品管理 API
- **查詢商品列表**: 依權限過濾店鋪，支援分頁與篩選
- **查詢單一商品**: 回傳商品詳細資訊與獎項列表
- **新增商品**: 建立商品並自動綁定到用戶所屬店鋪
- **更新商品**: 修改商品資訊（需權限檢查）
- **刪除商品**: 軟刪除或硬刪除（需檢查是否有訂單）
- **上架/下架**: 變更商品狀態

### 3.2 商品查詢 API（前端用）
- **依店鋪查詢商品**: 輸入店鋪 ID，回傳該店鋪所有上架商品
- **依分類查詢店鋪**: 輸入商品分類，回傳提供該分類的所有店鋪

---

## 四、權限控制細節

### 4.1 StoreEditor 權限限制
- **可操作**:
  - 商品管理（新增、編輯、上架/下架）
  - 獎項管理
  - 訂單管理（僅查看）
- **不可操作**:
  - 查看財務報表
  - 查看營收統計
  - 修改店鋪資訊
  - 建立或停用帳號

### 4.2 StoreOwner 權限
- 可操作自己店鋪的所有資料
- 可查看自己店鋪的報表
- 不可查看其他店鋪的資料
- 不可修改權限或建立帳號

### 4.3 Admin 權限
- 可查看與操作所有店鋪資料
- 可管理所有帳號與權限
- 可查看全平台報表

---

## 五、資料一致性與安全性

### 5.1 權限檢查點
- Controller 層需使用註解或攔截器檢查權限
- Service 層需驗證資料隔離（店鋪過濾）
- 敏感操作需雙重驗證（如刪除商品）

### 5.2 商品管理安全性
- 商品刪除前需檢查是否有未完成訂單
- 上架商品需檢查是否有可用獎項（剩餘數量 > 0）
- 定時上架需防止重複執行

### 5.3 資料完整性
- 商品必須綁定有效的店鋪 ID
- 分類欄位必須為列舉中的有效值
- 自定義扭蛋必須指定子類型

---

## 六、相關資料表

### 6.1 權限相關
- `admin_user` - 管理者帳號
- `role` - 角色定義
- `admin_user_role` - 用戶角色關聯
- `menu` - 選單/功能
- `role_menu` - 角色選單權限

### 6.2 商品相關
- `lottery` - 商品/抽獎活動主表
- `store` - 店鋪資訊
- `lottery_prize` - 商品獎項

---

## 七、測試驗證要點

### 7.1 權限測試
- 驗證 StoreOwner 無法查看其他店鋪的商品
- 驗證 StoreEditor 無法訪問財務報表
- 驗證 Admin 可以查看所有店鋪資料
- 驗證選單權限正確控制頁面顯示與操作

### 7.2 商品管理測試
- 驗證定時上架在指定時間正確執行
- 驗證商品與店鋪的綁定關係在交易中正確記錄
- 驗證商品分類僅接受列舉中的有效值
- 驗證商品刪除時有訂單則拒絕操作

### 7.3 資料隔離測試
- 驗證 StoreOwner 查詢商品時僅回傳自己店鋪的資料
- 驗證跨店鋪操作被正確拒絕
- 驗證 Admin 查詢可跨店鋪
