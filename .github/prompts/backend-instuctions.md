# 後端開發檢查清單與指南

此文件用於：

- ✅ 後端開發檢查清單
- ✅ PR / 程式碼審查標準
- ✅ 系統設計提示 / 指導
- ✅ 避免常見陷阱的最佳實踐

---

## 🧠 1. 通用後端設計原則

以下是正確的設計原則：

- 明確區分 **前端** 與 **後端**。
- 前端僅使用 **OAuth2 (Google)**。
- 實現 **JWT (存取 + 更新)** 驗證。
- 統一 **API 回應格式**。
- 強制執行 **RBAC (基於角色的存取控制)**。
- 使用 **全域例外處理器**。
- 避免直接向前端暴露錯誤細節。
- 確保 **點數、庫存、抽獎** 的可追溯性。

這些是 **商業級生產系統** 的標準。

---

## 🧱 2. 後端模組分層

後端應分為以下邏輯層以保持清晰：

### 1️⃣ Controller (處理 HTTP)

- 接收請求。
- 驗證請求（`@Valid`）。
- 呼叫 Service 層。
- 返回 `ResponseEntity<ApiResponse<>>`。

**避免：**
- 寫業務邏輯。
- 直接訪問資料庫。

---

### 2️⃣ Service (核心業務邏輯)

處理：
- 抽獎流程。
- 點數扣除。
- 庫存減少。
- 權限檢查（例如操作資格）。
- 交易一致性（`@Transactional`）。

👉 **99% 的錯誤發生在此層。**

---

### 3️⃣ Repository / DAO (資料庫訪問)

- 單一職責。
- 不混合業務邏輯。
- 查詢必須有明確目的。

---

### 4️⃣ 安全層 (關鍵)

- JWT 過濾器。
- OAuth2 成功處理器。
- RBAC 權限檢查器。
- CORS / CSRF 配置。

---

## 🔐 3. 驗證與安全

### ✅ 使用者來源 (關鍵)

`User` 表必須包含：
- `provider`（例如 LOCAL, GOOGLE）。
- `provider_id`（例如 Google 的 `sub`）。

**行為規則：**
| 情境                  | 規則                          |
|-----------------------|-------------------------------|
| Google 登錄帳號       | ❌ 不可設置密碼。             |
| 本地註冊              | ❌ 不可使用 Google 登錄。     |
| 重複電子郵件          | 必須檢查 `provider`。         |

---

### 🔑 JWT 機制 (必須)

#### 存取 Token：
- 短效（15–30 分鐘）。
- 存儲於標頭中。
- 每次 API 呼叫都需驗證。

#### 更新 Token：
- 長效（7–30 天）。
- 存儲於資料庫（或 Redis）。
- 可撤銷。
- 綁定設備/IP（進階）。

**避免：**
- ❌ 無限制使用更新 Token。
- ❌ 不將更新 Token 存儲於資料庫。

---

### 🌐 CORS / CSRF

針對前後端分離：
- 配置 `allowOrigins`、`allowHeaders`、`allowMethods`。
- 白名單 OAuth 重定向 URL。

---

## 📦 4. 請求 / 回應設計

### 統一回應格式：
```json
ResponseEntity.ok(ApiResponse.success(data));
```

#### 範例 `ApiResponse` 結構：
```json
{
    "success": true,
    "code": "OK",
    "message": "success",
    "data": {}
}
```

#### 錯誤時：
```json
{
    "success": false,
    "code": "AUTH_001",
    "message": "Invalid token"
}
```

---

## 🚨 5. 全域例外處理

使用 `@RestControllerAdvice` 處理：
- `ValidationException`
- `AuthenticationException`
- `AccessDeniedException`
- `BusinessException`（自定義）
- `Exception`（回退）

### 原則：
- ❌ 不返回堆疊追蹤。
- ❌ 不暴露資料庫錯誤。
- ✔ 返回自定義錯誤代碼。

---

## 🧮 6. 點數 / 庫存 / 抽獎

### 抽獎流程（事務性）：
```java
@Transactional
public DrawResult draw(...) {
    // 1. 檢查庫存
    // 2. 檢查點數
    // 3. 扣除點數
    // 4. 扣除庫存
    // 5. 寫入抽獎日誌
}
```

### 防止問題：
- 重複扣除。
- 超賣。
- 並發抽獎請求。
- 回滾不完整。

---

### 🔒 庫存鎖定（關鍵）：
- **資料庫行鎖**。
- **樂觀鎖**（版本控制）。
- **Redis 鎖**（進階）。

---

## 🧾 7. 關鍵考量

### ✅ 幂等性：
- 使用 `request_id` 防止重複請求（例如支付、抽獎）。

### ✅ 審計日誌：
- 追蹤管理員操作。
- 記錄財務與庫存變更。

### ✅ 限流：
- 防止暴力破解登錄。
- 減輕 API 濫用。

### ✅ 軟刪除：
- 使用 `deleted_at` 代替硬刪除。

### ✅ 時區 / 精度：
- 金額使用 `BigDecimal`。
- 時間戳使用 UTC。

### ✅ API 版本控制：
- 範例：`/api/v1/...`

### ✅ Swagger / OpenAPI：
- 避免暴露內部錯誤。
- 限制 Token 測試。

---

## 🧩 8. 後端完成檢查清單

### 🔐 安全：
- JWT 存取 / 更新 Tokens。
- OAuth2（僅前端使用 Google）。
- 區分 `provider`（本地/Google）。
- CORS 配置。
- RBAC（角色 + 菜單）。

---

### 📡 API：
- 統一 `ApiResponse`。
- 請求驗證。
- API 版本控制。
- 限流。

---

### 🧠 業務邏輯：
- 事務性抽獎流程。
- 點數一致性。
- 庫存鎖定。
- 幂等性處理。

---

### 🧾 日誌：
- 操作日誌。
- 財務變更日誌。
- 例外日誌。

---

### 🚨 例外：
- 全域處理器。
- 自定義錯誤代碼。
- 回應中不包含堆疊追蹤。
- 
