# 抽獎遊戲管理開發指引

## 文件用途
本文件為 AI 編碼代理開發「抽獎遊戲管理」相關功能時的參照指引。

## ⚠️ 開發前必讀
- **專案架構**: 請先閱讀 `architecture-guide.prompt.md` 了解 MyBatis Generator (MBG) 使用規範
- **開發流程**: DDL 優先 → 執行 MBG → 使用 Example 查詢 → 必要時才手寫 SQL
- **資料表設計**: 本文件提供欄位需求，需轉換為 DDL 後執行 MBG 生成程式碼

---

## 核心概念

### 1. 獎項資料結構
開發獎項相關功能時，須包含以下欄位：
- **獎項名稱** (`prize_name`)
- **等級** (`level`): A/B/C/D/E/F/G / 大賞 / 小賞
- **剩餘數量** (`remaining_quantity`)
- **獎項圖片** (`prize_image_url`)
- **編號** (`prize_number`): 籤號或刮刮樂號碼

### 2. 獎池邏輯實作要點

#### 固定數量池
- 獎品總數固定，抽完即結束
- 需實作剩餘數量檢查機制
- 當 `remaining_quantity = 0` 時，該獎項不可再被抽中

#### 抽獎機率計算
- **平等機率原則**: 每一抽的中獎機率 = 1 / 剩餘籤數
- 需即時查詢當前剩餘總籤數（所有獎項的 remaining_quantity 總和）
- 計算邏輯：假設剩餘 50 張籤，每張中獎機率為 2%
- 抽獎時需先計算總剩餘數，再隨機選取

#### 自製賞刮刮樂模式
- **選號機制**:
  - 玩家可從開放號碼範圍中選擇特定號碼
  - 系統需提供「可選號碼列表」查詢功能
  - 已被抽走的號碼需標記為不可選（避免重複選號）
  - 號碼範圍由商品設定決定（如 1-100）
  
- **並發控制需求**:
  - 使用資料庫樂觀鎖或悲觀鎖防止同一號碼被重複選取
  - 交易隔離等級建議使用 SERIALIZABLE
  - 執行順序：鎖定號碼 → 檢查可用性 → 執行抽獎 → 更新剩餘數量
  - 失敗時需回滾並提示使用者該號碼已被選取

### 3. 特殊玩法開發規範

#### 最後賞機制
- **資料需求**:
  - 需要欄位標記是否為「最後賞」（boolean）
  - 可選：固定號碼（若最後賞有特定號碼）
  - 可選：是否同時放入一般籤池（影響中獎邏輯）

- **觸發邏輯**:
  - 當剩餘總籤數 = 1 且該籤被標記為最後賞時
  - 系統必定回傳該最後賞獎項
  - 不執行隨機邏輯，直接鎖定該獎項

#### 大獎售完自動降價
- **設定需求**:
  - 是否啟用自動降價（boolean）
  - 降價金額（decimal，如降 50 元）
  - 觸發條件：指定獎項等級（如 A 等獎）售完時觸發
  
- **觸發時機**:
  - 當指定等級（如 A 等）的 `remaining_quantity` 變為 0 時
  - 系統自動將該商品的 `current_price` 減去 `discount_amount`
  - 需記錄降價事件與時間（用於報表與通知）
  - 降價後前台即時顯示新價格

### 4. 抽獎保護時間機制

#### 業務規則
- **鎖定時機**: 玩家首次對該商品進行抽獎時，自動建立鎖定
- **保護時長**: 鎖定 5 分鐘（從第一次抽獎開始計算）
- **保護期間行為**: 其他玩家無法對該商品進行任何抽獎操作
- **解鎖時機**: 
  - 保護時間到期後自動解鎖
  - 系統需定期（如每分鐘）檢查過期鎖定並清除

#### 資料需求
- **lottery_locks 表欄位**:
  - `lottery_id`: 被鎖定的商品 ID
  - `user_id`: 鎖定者的使用者 ID
  - `lock_start_time`: 鎖定開始時間
  - `lock_end_time`: 鎖定結束時間（start_time + 5分鐘）
  - `is_active`: 鎖定是否仍然有效

#### 檢查邏輯
- 抽獎前需先查詢是否有 active 的鎖定記錄
- 若無鎖定 → 允許抽獎並建立新鎖定
- 若有鎖定且為自己 → 允許繼續抽獎
- 若有鎖定且鎖定已過期 → 解除舊鎖定並允許抽獎
- 若有鎖定且為他人且未過期 → 拒絕抽獎並提示剩餘鎖定時間

## API 設計參考

### 獎項管理
- `GET /api/lottery/{id}/prizes` - 查詢指定商品的所有獎項列表
- `POST /api/lottery/{id}/prizes` - 為商品新增獎項
- `PUT /api/lottery/prizes/{prizeId}` - 更新獎項資訊
- `DELETE /api/lottery/prizes/{prizeId}` - 刪除獎項

### 抽獎執行
- `POST /api/lottery/{id}/draw` - 執行隨機抽獎（一般模式）
- `POST /api/lottery/{id}/draw/select` - 選號抽獎（刮刮樂模式）
- `GET /api/lottery/{id}/available-numbers` - 查詢可選號碼清單

### 保護鎖定
- `GET /api/lottery/{id}/lock-status` - 查詢商品的鎖定狀態
- `POST /api/lottery/{id}/lock` - 建立鎖定（通常在首次抽獎時自動觸發）

---

## 實作注意事項

### 交易與並發
- 所有涉及 `remaining_quantity` 變更的操作**必須使用事務**（`@Transactional`）
- 並發抽獎場景需使用樂觀鎖或分布式鎖確保資料一致性
- 避免超抽：更新前需再次檢查剩餘數量

### 資料完整性
- 抽獎記錄需完整保存於 `lottery_draw_record` 表
- 記錄內容包含：使用者 ID、商品 ID、獎項 ID、抽獎時間、消耗點數
- 特殊玩法（最後賞、自動降價）的觸發事件需記錄日誌

### 配置化設計
- 特殊玩法（最後賞、自動降價、保護時間）應可由後台開關控制
- 保護時間長度應可設定（預設 5 分鐘）
- 自動降價金額與觸發條件應可彈性調整

## 相關資料表

### 主要資料表
- **lottery** - 抽獎活動主表（商品資訊、價格、狀態）
- **lottery_prize** - 獎項表（獎項名稱、等級、剩餘數量、圖片）
- **lottery_draw_record** - 抽獎記錄（誰、何時、抽中什麼）
- **lottery_locks** - 抽獎鎖定表（保護時間機制，需新建）

### 資料表關聯
- `lottery` 1:N `lottery_prize`（一個商品有多個獎項）
- `lottery` 1:N `lottery_draw_record`（一個商品有多筆抽獎記錄）
- `lottery` 1:N `lottery_locks`（一個商品可能有鎖定記錄）
- `user` 1:N `lottery_draw_record`（一個使用者有多筆抽獎記錄）

---

## 測試驗證要點

### 功能測試
- **並發測試**: 多人同時抽同一商品，驗證不會超抽
- **最後賞測試**: 剩餘最後一籤時，驗證必定抽中最後賞
- **保護時間測試**: 驗證 5 分鐘內其他玩家無法抽獎
- **自動降價測試**: 驗證 A 等獎售完後價格自動調整

### 邊界條件測試
- 剩餘數量為 0 時是否正確拒絕抽獎
- 保護時間過期後是否正確解鎖
- 選號模式下號碼重複選取是否正確拒絕
- 並發情況下樂觀鎖是否正常運作

### 資料一致性測試
- 抽獎後 `remaining_quantity` 是否正確遞減
- `lottery_draw_record` 是否完整記錄所有抽獎
- 降價事件是否正確記錄
- 鎖定記錄的 `is_active` 狀態是否正確更新

---

**最後更新**: 2025-12-14  
**參考文件**: `architecture-guide.prompt.md`
